# Passo a passo — inserir dicionários na DB (simples e seguro)

1. **Prepare a conexão e o cursor** (use `with` para fechar automaticamente)

```python
with conn:
    with conn.cursor() as cur:
        ...
```

2. **Query com *named placeholders* (`%(chave)s`)**

   * Escreva a SQL referenciando as chaves do dicionário:

```python
sql = "INSERT INTO customers (nome, idade) VALUES (%(nome)s, %(idade)s);"
data = {"nome": "Luiz", "idade": 27}
cur.execute(sql, data)
conn.commit()
```

* Ordem no dicionário **não importa** — o placeholder usa o nome da chave.

3. **Quando as chaves do dicionário são diferentes dos nomes de coluna**

   * Mapeie as chaves antes de executar:

```python
d = {"name": "Luiz", "age": 27}           # dados recebidos
mapa = {"nome": "name", "idade": "age"}   # coluna -> chave_do_dicionario

params = {col: d[chave] for col, chave in mapa.items()}
# params = {"nome": "Luiz", "idade": 27}
cur.execute(sql, params)
conn.commit()
```

4. **Inserir muitos dicionários (executemany)**

```python
lista = [
  {"nome": "Ana", "idade": 30},
  {"nome": "Pedro", "idade": 22},
]
cur.executemany(sql, lista)
conn.commit()
```

5. **Lendo JSON → dicionários → DB**

   * Carregue JSON (`json.loads`) → lista de dicts → adapte chaves se necessário → `executemany`.

6. **Boas práticas / cuidados**

   * **Valores**: use placeholders (como acima) — a biblioteca trata a **escapagem** e evita SQL injection.
   * **Nomes de colunas** (identificadores): **não** podem ser placeholders. Se for inserir dinamicamente colunas, **valide/normalize** os nomes antes de interpolar na string SQL:

```python
# EXEMPLO SEGURO: apenas permitir colunas conhecidas
colunas_permitidas = {"nome","idade"}
col = "nome"
if col in colunas_permitidas:
    sql = f"INSERT INTO customers ({col}) VALUES (%({col})s);"
```

* Sempre `commit()` após INSERT/UPDATE/DELETE (ou use `with conn:` se o driver faz commit automático).
* Trate exceções e use `rollback()` em erro.

7. **Resumo rápido**

   * Usar `%(chave)s` permite enviar dicionários diretamente.
   * Mapear chaves quando nomes não batem.
   * `executemany` para lotes.
   * Nunca concatenar valores em strings SQL.

Quer que eu gere um snippet completo `insert_from_dicts.py` pronto pra colar no seu projeto?
