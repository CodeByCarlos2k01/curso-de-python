Aqui está a explicação sobre **como criar um Context Manager usando função e decorator** simplificada em passos:

---

### 1. **Importar o decorator**

```python
from contextlib import contextmanager
```

* `contextmanager` transforma uma função em um Context Manager.

---

### 2. **Criar a função do Context Manager**

```python
@contextmanager
def my_open(caminho_arquivo, modo):
    print("Abrindo arquivo")
    arquivo = open(caminho_arquivo, modo, encoding='utf-8')
    try:
        yield arquivo  # pausa e devolve o arquivo para o bloco with
    finally:
        print("Fechando arquivo")
        arquivo.close()
```

* `yield` separa a **configuração (enter)** do **final (exit)**.
* Tudo que estiver **antes do yield** é executado ao **entrar no with**.
* Tudo que estiver **depois do yield** é executado ao **sair do with**, mesmo se houver erro.

---

### 3. **Usar o Context Manager**

```python
with my_open("arquivo.txt", "w") as f:
    f.write("Linha 1\nLinha 2\nLinha 3\n")
```

* O arquivo é aberto antes do bloco (`yield`),
* e fechado depois do bloco (`finally`).

---

### 4. **Tratamento de exceções**

* Se necessário, você pode capturar exceções dentro do bloco `try`:

```python
@contextmanager
def my_open(caminho_arquivo, modo):
    print("Abrindo arquivo")
    arquivo = open(caminho_arquivo, modo, encoding='utf-8')
    try:
        yield arquivo
    except Exception as e:
        print("Ocorreu um erro:", e)
        raise  # opcional: relança a exceção
    finally:
        print("Fechando arquivo")
        arquivo.close()
```

---

### 5. **Resumo**

1. Decorar a função com `@contextmanager`.
2. Abrir ou configurar recurso **antes do `yield`**.
3. `yield` passa o recurso para o bloco `with`.
4. Fechar ou limpar recurso **depois do `yield`**.
5. `try/finally` garante que o recurso seja fechado mesmo se ocorrer erro.

---

Se quiser, posso fazer um **diagrama visual comparando o Context Manager com classe vs função**, para ficar ainda mais claro como o fluxo de enter/yield/exit funciona. Quer que eu faça isso?
